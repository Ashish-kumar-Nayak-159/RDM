<div class="tab-bar">
  <div class="d-flex d-flex align-items-center">
    <div class="h6 m-0 p-0">
      Roles
      <ng-container *ngIf="decodedToken?.privileges && decodedToken.privileges.indexOf('APMM') > -1">
        <button type="button" class="btn btn-sm searchBtn btn-primary" placement="bottom" tooltip="Add Role"
          (click)="openCreateUserModal()"><em class="fas fa-plus fa-sm"></em></button>
      </ng-container>
    </div>
  </div>
</div>
<div class="tableFixHead table-responsive">
  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">Role Name </th>
        <th scope="col">Access Level</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngIf="userRoles.length > 0 && !isUserRolesAPILoading">
      <ng-container *ngFor="let item of userRoles; let configIndex = index">
        <tr [ngClass]="{ 'accordion-bg' : toggleRows[configIndex] }">
          <td>{{item.role}}</td>
          <td>Level: {{applicationData.hierarchy.levels[item.level]}}</td>
          <td>
            <a href="javascript:void(0)" (click)="toggleRows[configIndex] && pageType === 'view' ? onToggleRows(configIndex, 'view', 'toggle') :  onToggleRows(configIndex, 'view', 'notoggle') ">
              <!-- <em [ngClass]="toggleRows[configIndex] && pageType === 'view' ? 'fa fa-angle-up' : 'fa fa-eye'" placement="bottom" tooltip="View Role"></em> -->
              <em class="fa fa-eye" placement="bottom" tooltip="View Role"></em>
            </a>
            <a href="javascript:void(0)" (click)="toggleRows[configIndex] && pageType === 'edit' ? onToggleRows(configIndex, 'edit', 'toggle') : onToggleRows(configIndex, 'edit', 'notoggle') " class="ml-2"
              *ngIf="item.role !== constantData.APP_ADMIN_ROLE && decodedToken?.privileges && decodedToken.privileges.indexOf('APMM') > -1">
              <!-- <em [ngClass]="toggleRows[configIndex] && pageType === 'edit' ? 'fa fa-angle-up' : 'fa fa-edit'" placement="bottom" tooltip="Edit Role"></em> -->
              <em class="fa fa-edit" placement="bottom" tooltip="Edit Role"></em>
            </a>
            <!-- <a href="javascript:void(0)" (click)="onSaveRoles()"
              *ngIf="item.role !== constantData.APP_ADMIN_ROLE && toggleRows[configIndex] && pageType === 'edit' && decodedToken?.privileges && decodedToken.privileges.indexOf('APMM') > -1"
              class="ml-2">
              <em [ngClass]="'fa fa-save'" placement="bottom" tooltip="Save Role"></em>
            </a> -->
            <a *ngIf="item.role !== constantData.APP_ADMIN_ROLE && decodedToken?.privileges && decodedToken.privileges.indexOf('APMM') > -1"
              href="javascript:void(0)" class="ml-2" (click)="openDeleteUserModal(configIndex)">
              <em class="fa fa-trash" placement="bottom" tooltip="Delete Role"></em>
            </a>
          </td>
        </tr>
        <tr *ngIf="toggleRows[configIndex]" style="background-color: #fdfeff;">
          <td colspan="3" class="p-0">
            <table class="table table-content" style="background-color: #fdfeff;">
              <tfoot>
                <tr *ngIf="item.role !== constantData.APP_ADMIN_ROLE && decodedToken?.privileges && decodedToken.privileges.indexOf('APMM') > -1"> 
                  <td colspan="3">
                    <button type="button" class="btn btn-primary btn-sm mx-1 my-1" (click)="onSaveRoles(configIndex)"
                      [disabled]="saveRoleAPILoading || pageType === 'view'">SAVE <em
                        class="fa fa-spinner fa-spin fa-fw fa-2x" *ngIf="saveRoleAPILoading"></em></button>
                    <button type="button" class="btn btn-white btn-sm mx-1 my-1" (click)="onCancelClick()"
                      [disabled]="pageType === 'view'">CANCEL</button>
                  </td>
                </tr>
              </tfoot>
              <tbody>
                <tr >
                  <td><input type="checkbox" name="visibleall_{{configIndex}}"
                    id="visibleall_{{configIndex}}" (change)="onClickOfAllCheckbox(configIndex)" [(ngModel)]="isAllprivilegeSelected[configIndex]"
                    placement="bottom" [tooltip]="isAllprivilegeSelected[configIndex] ? 'Deselect All' : 'Select All'" [disabled]="pageType === 'view'"/>
                    <label for="visibleall_{{configIndex}}"
                    class="ml-2 mb-0">{{isAllprivilegeSelected[configIndex] ? 'Deselect All' : 'Select All'}}</label>
                  </td>
                </tr>
                <tr>
                  <td class="accordion-border">
                    <div class="row m-0 mb-4">
                      <div *ngFor="let group of privilegeGroups | keyvalue" class="col-6">
                        <h6 class="mt-4 mb-2 font-weight-light-bold">{{group.key}}</h6>
                        <div *ngFor="let privilege of group.value" class="pl-3">
                          <input type="checkbox" name="{{privilegeObj[configIndex].privileges[privilege]?.display_name}}_{{configIndex}}"
                            id="{{privilegeObj[configIndex].privileges[privilege]?.display_name}}_{{configIndex}}"  (change)="onPrivilegeSelection(configIndex)" 
                            [(ngModel)]="privilegeObj[configIndex].privileges[privilege].enabled" [disabled]="pageType == 'view'" />
                          <label for="{{privilegeObj[configIndex].privileges[privilege]?.display_name}}_{{configIndex}}"
                            class="col-form-label">&nbsp;&nbsp;{{privilegeObj[configIndex].privileges[privilege]?.display_name}}</label>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table> 
          </td>
        </tr>
      </ng-container>
      </ng-container>
      <ng-container *ngIf="isUserRolesAPILoading">
        <tr>
          <td colspan="5"><em class="fa fa-spinner fa-spin fa-fw fa-2x"></em></td>
        </tr>
      </ng-container>
      <ng-container *ngIf="!isUserRolesAPILoading && userRoles.length === 0">
        <tr>
          <td colspan="5">No User Roles Found.</td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>

<div class="modal right fade" id="createUserModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel2">
  <div class="modal-dialog" role="document">
    <div class="modal-content" *ngIf="privilegeObj['add']">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">{{privilegeObj['add'].id ? 'Edit': 'Add New'}} Role</h5>
        <button type="button" class="close" [disabled]="isCreateUserAPILoading" (click)="onCloseCreateUserModal()">
          <span aria-hidden="true" tooltip="Close">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form #form="ngForm">
          <div class="form-group">
            <label for="message-text" class="col-form-label required">App Name:</label>
            <input type="text" class="form-control form-control-sm" id="app" [defaultValue]="applicationData.app"
              disabled />
          </div>
          <div class="form-group">
            <label for="recipient-name" class="col-form-label required">Role:</label>
            <input #roleName="ngModel" validateText type="text" class="form-control form-control-sm" id="role" placeholder="Enter Role Name"
              [(ngModel)]="privilegeObj['add'].role" name="roleName" [disabled]="privilegeObj['add'].id" />
              <div *ngIf="roleName.errors?.whitespace && roleName.touched" class="alert-danger">
                Please enter valid name.
              </div>
          </div>
          <div class="form-group">
            <label for="recipient-name" class="col-form-label required">Level:</label>
            <select class="form-control form-control-sm" id="userRoleCategory" [disabled]="privilegeObj['add'].id"
              [(ngModel)]="privilegeObj['add'].level" name="userRoleCategory">
              <option [ngValue]="i" *ngFor="let level of applicationData.hierarchy.levels; let i = index;">
                {{level}}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="recipient-name" class="col-form-label required">User Privileges:</label>
            <div>
              <input type="checkbox" name="visibleall_add"
                id="visibleall_add" (change)="onClickOfAllCheckbox('add')" [(ngModel)]="isAllprivilegeSelected['add']"
                placement="bottom" [tooltip]="isAllprivilegeSelected['add'] ? 'Deselect All' : 'Select All'" />
                <label for="visibleall_add"
                class="ml-2 mb-0">{{isAllprivilegeSelected['add'] ? 'Deselect All' : 'Select All'}}</label>
            </div>
            <div *ngFor="let group of privilegeGroups | keyvalue">
              <h6 class="my-3">{{group.key}}</h6>
              <div *ngFor="let privilege of group.value" class="ml-3">
                <input type="checkbox" name="{{privilegeObj['add'].privileges[privilege].display_name}}_add"
                  id="{{privilegeObj['add'].privileges[privilege].display_name}}_add"  (change)="onPrivilegeSelection('add')" 
                  [(ngModel)]="privilegeObj['add'].privileges[privilege].enabled" />
                <label for="{{privilegeObj['add'].privileges[privilege].display_name}}_add"
                  class="col-form-label">&nbsp;&nbsp;{{privilegeObj['add'].privileges[privilege].display_name}}</label>
              </div>
            </div>
          </div>
       
      <div class="modal-footer fixed-bottom bg-white">
        <button type="button" class="btn btn-primary add-row" (click)="onSaveRoles('add')"
          [disabled]="!form.valid || isCreateUserAPILoading">
          Save
          <em class="fa fa-spinner fa-spin fa-fw fa-2x" *ngIf="isCreateUserAPILoading"></em>
        </button>
        <button type="button" class="btn btn-secondary" [disabled]="isCreateUserAPILoading"
          (click)="onCloseCreateUserModal()">
          Cancel
        </button>
      </div>
    </form>
   </div>
    </div>
  </div>
</div>


<div class="modal fade" id="confirmMessageModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel2">
  <div class="modal-dialog" role="document">
    <app-confirm-modal *ngIf="modalConfig" [bodyMessage]="'Are you sure you want to remove this role?'"
      [headerMessage]="'Delete Role'" (modalEvents)="onModalEvents($event)" [modalConfig]="modalConfig">
    </app-confirm-modal>
  </div>
</div>
