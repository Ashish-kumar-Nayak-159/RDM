<div class="topnavbar" [style.marginTop]="pageType === 'live' ? '1.5rem' : ''" >
  <div class="d-sm-flex align-items-center justify-content-start mb-2 mt-n3 pl-1" *ngIf="pageType === 'side_menu'">
    <h5 class="h4 mb-0 text-gray-800">{{tileData && tileData[0] ? tileData[0]?.value : ''}}</h5>
  </div>
  <div class="card row bg-white" [style.marginLeft]="pageType === 'live' ? '-2rem' : '-1.5rem'"
  [style.borderRadius]= "pageType === 'live' ? '' : '0'"
  [style.border]= "pageType === 'live' ? '' : 'none'">
    <div class="col-xl-12 col-md-12 mb-12">
      <form>
        <div class="form-group form-inline my-2" [ngClass]="pageType !== 'live' ? 'mx-3' : 'mx-4'" *ngIf="pageType !== 'history'">
          <ng-container *ngFor="let level of contextApp?.hierarchy?.levels; let index = index;">
          <select *ngIf="index !== 0" class="form-control form-control-sm ml-2 mr-1 my-1" id="{{level}}"
          [disabled]="contextApp?.user?.hierarchy[level]"
          [(ngModel)]="configureHierarchy[index]" name="{{level}}" (change)="onChangeOfHierarchy(index)">
            <option [ngValue]="undefined">Select {{level}}</option>
            <option [ngValue]="tag" *ngFor="let tag of hierarchyArr[index]">
              {{tag}}
            </option>
          </select>
          <input  type="text" *ngIf="index === 0"  defaultValue="{{contextApp.app}}" disabled class="form-control form-control-sm mx-1 my-1">
          </ng-container>
          <select class="form-control form-control-sm mx-2 my-1" id="deviceCategory" [(ngModel)]="filterObj.device"
          name="deviceCategory" [compareWith]="compareFn">
          <option [ngValue]="undefined">Select Asset</option>
          <option [ngValue]="device" *ngFor="let device of devices">
            {{device?.display_name ? device?.display_name: device.device_id}}
          </option>
          </select>
          <!-- <select class="form-control form-control-sm mx-2 my-1" id="deviceCategory1" [(ngModel)]="filterObj.non_ip_device"
            name="deviceCategory1" *ngIf="filterObj.device?.cloud_connectivity.includes('Gateway')"
            >
            <option [ngValue]="undefined">Select Asset</option>
            <option [ngValue]="device" *ngFor="let device of nonIPDevices">
              {{device?.display_name ? device?.display_name: device.device_id}}
            </option>
          </select> -->
          <button type="button" *ngIf="pageType === 'live'" class="btn btn-warning btn-sm mx-1 my-1" title="Search" (click)="getLatestAlerts()"><i
            class="fa fa-search fa-sm"></i></button>
        </div>
        <ng-container *ngIf="pageType === 'history' || pageType === 'side_menu'">
        <div class="form-group form-inline  my-2 mx-3">

          <input type="number" min="1" class="form-control form-control-sm mx-1 my-1 record-input" id="inputEmail4"
            placeholder="No of Records" [(ngModel)]="filterObj.count" name="count">
          <!-- <select class="form-control form-control-sm mx-1 my-1" id="deviceCategory" [(ngModel)]="filterObj.device"
            name="deviceCategory" (change)="onAssetSelection()">
            <option [ngValue]="undefined">Select Asset</option>
            <option [ngValue]="device" *ngFor="let device of devices">
              {{device?.display_name ? device?.display_name: device.device_id}}
            </option>
          </select>
          <select class="form-control form-control-sm mx-1 my-1" id="deviceCategory1" [(ngModel)]="filterObj.non_ip_device"
            name="deviceCategory1" *ngIf="filterObj.device?.tags?.category === 'IoT Gateway'">
            <option [ngValue]="undefined">Select Asset</option>
            <option [ngValue]="device" *ngFor="let device of nonIPDevices">
              {{device?.display_name ? device?.display_name: device.device_id}}
            </option>
          </select> -->

          <!-- <select class="form-control form-control-sm mx-2 my-1" id="dateoptions" [(ngModel)]="filterObj.acknowledged"
            name="dateOptions">
            <option [ngValue]="undefined">Status</option>
            <option [ngValue]="'true'">Acknowledged</option>
            <option [ngValue]="'false'">Not Acknowledged</option>
          </select> -->
          <div class="bg-dateRow form-group form-inline" id="dateRow"
          [style.width]="(filterObj.dateOption === 'date' ? '23rem' : (filterObj.dateOption === 'date range' ? '33rem' : ''))">
          <select class="form-control form-control-sm mx-2 my-1" id="dateoptions" [(ngModel)]="filterObj.dateOption"
            name="dateOptions" (change)="onDateOptionChange()">
            <option [ngValue]="undefined">Quick Date Options</option>
            <option [ngValue]="'5 mins'">Last 5 minutes</option>
            <option [ngValue]="'30 mins'">Last 30 minutes</option>
            <option [ngValue]="'1 hour'">Last 1 hour</option>
            <option [ngValue]="'24 hour'">Last 24 hours</option>
            <option [ngValue]="'date'">Select Date</option>
            <option [ngValue]="'date range'">Select Date Range</option>
          </select>
          <!-- <label class="ml-1 mr-1">OR</label> -->
          <ng-container *ngIf="filterObj.dateOption === 'date'">
            <input #dt2Input [owlDateTime]="dt2"  (dateTimeChange)="onSingleDateChange($event);"
              class="form-control form-control-sm mx-2 my-1 w-10" [owlDateTimeTrigger]="dt2"
              placeholder="Select Date">
            <span [owlDateTimeTrigger]="dt2"  class="datepicker-calendar"><i class="fa fa-calendar"></i></span>
            <owl-date-time #dt2 [pickerType]="'calendar'"></owl-date-time>
          </ng-container>
          <ng-container *ngIf="filterObj.dateOption === 'date range'">
            <input  #dt1Input [owlDateTime]="dt1" [selectMode]="'range'" (dateTimeChange)="onDateChange($event)"
              class="form-control form-control-sm mx-2 my-1 date-range-picket-width" [owlDateTimeTrigger]="dt1"
              placeholder="Select Date Time">
            <span [owlDateTimeTrigger]="dt1" class="datepicker-calendar"><i class="fa fa-calendar"></i></span>
            <owl-date-time #dt1></owl-date-time>
          </ng-container>
          </div>
          <button type="button" class="btn btn-warning btn-sm mx-3 my-1" title="Search" (click)="getLatestAlerts()"><i
              class="fa fa-search fa-sm"></i></button>
          <!-- <button type="button" class="btn btn-white btn-sm mx-1 my-1" title="Clear" (click)="clear()"><i class="fa fa-trash  fa-sm"></i></button> -->
        </div>
      </ng-container>
      </form>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <hr class="solid">
    </div>
  </div>
  <!-- <div class="card row bg-white" style="margin-left:-2rem">
    <div class="col-xl-12 col-md-12 mb-12">
      <form>
        <div class="form-group form-inline  my-2 mx-3">
          <input type="number" class="form-control form-control-sm my-1" id="app" style="width: 5%;" name="app"
            [(ngModel)]="beforeInterval">
          <button class="btn btn-secondary btn-sm" style="pointer-events: none;">mins before alert</button>
          <input type="number" class="form-control form-control-sm my-1" id="inputEmail4" style="width: 5%;" name="name"
            [(ngModel)]="afterInterval">
          <button class="btn btn-secondary btn-sm" style="pointer-events: none;">mins after alert</button>
        </div>

      </form>
    </div>
  </div> -->
</div>

<div class="contain-pad" [style.marginTop]="pageType === 'live' ? '3rem': (pageType === 'history' ? '9.5rem': '13.5rem')">
  <div class="mb-2">
    <div class="table-responsive mx-2">
      <table class="table table-bordered table-striped" id="dataTable" width="100%" cellspacing="0">
        <thead>
          <tr class="bg-secondary text-white">
            <th></th>
            <th>Asset Name</th>
            <th>Description</th>
            <th>Time</th>
            <th>Status</th>
            <th>Acknowledged By</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngIf="latestAlerts.length > 0 && !isAlertAPILoading">
            <tr *ngFor="let alert of latestAlerts" [ngClass]="{
                    'bg-alert-selection':
                      alert.id ? alert.id === selectedAlert?.id : alert.alert_id === selectedAlert?.alert_id,
                      'bg-danger text-white': alert?.severity?.toLowerCase() === 'critical'
                  }" >
              <td><i class="fa fa-exclamation-triangle" [style.color]="
                (alert?.severity?.toLowerCase() === 'critical' ? '#cc0000' :
                (alert?.severity?.toLowerCase() === 'error' ? '#fb5515' :
                (alert?.severity?.toLowerCase() === 'warning' ? '#f6c23e' :
                (alert?.severity?.toLowerCase() === 'informational' ? '#229954' : ''))
                )
                )" title="{{alert.severity}}"></i></td>
              <td>{{ alert.device_display_name ? alert.device_display_name : alert.device_id }}</td>
              <td>{{ alert.message }}</td>
              <td>{{ alert.local_created_date }}</td>
              <td>
                <ng-container *ngIf="alert.metadata?.acknowledged_date">Acknowledged</ng-container>
                <button *ngIf="!alert.metadata?.acknowledged_date" class="btn btn-sm btn-secondary"
                  (click)="onClickOfAcknowledgeAlert(alert)">Acknowledge</button>
              </td>
              <td>{{ alert.metadata?.user_id }}</td>
              <td>
                <a href="javascript:void(0)" (click)="onClickOfViewGraph(alert)">
                  <i class="fa fa-search" [style.color]="alert?.severity?.toLowerCase() === 'critical' ? 'white' : ''"></i>
                </a>
              </td>
            </tr>
          </ng-container>
          <ng-container *ngIf="latestAlerts.length === 0 && !isAlertAPILoading">
            <tr>
              <td colspan="7">No Alert data available.</td>
            </tr>
          </ng-container>
          <ng-container *ngIf="isAlertAPILoading">
            <tr>
              <td colspan="7">
                <i class="fa fa-fw fa-2x  fa-spin fa-spinner"></i>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

</div>


<div class="modal fade" id="alertVisualizationModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel2">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content" *ngIf="selectedAlert">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">View Alert Data</h5>
        <button type="button" class="close" (click)="closeModal('alertVisualizationModal')" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="isAlertModalDataLoading"> <i class="fa fa-fw fa-2x  fa-spin fa-spinner"></i></ng-container>
        <ng-container *ngIf="!isAlertModalDataLoading">
          <accordion *ngIf="selectedAlert" class="mb-2 mx-2">
            <accordion-group heading=""  [panelClass]="'customClass'" [isOpen]="isOpen">
              <ng-container accordion-heading>
                <a class="btn" >
                  Filters
                </a>
              </ng-container>
              <div class="">
                <div class="">
                  <div class="">
                    <div class="col-xl-10 col-lg-10 col-md-10">
                      <form>
                        <div class="form-group form-inline my-1">
                          <label class="mr-2"> Time Range: </label>
                          <input type="number" class="form-control form-control-sm my-1" step="1" min="0" id="beforeInterval" style="width: 9%;"
                            name="beforeInterval" [(ngModel)]="beforeInterval" (change)="onChangeTimeValue()">
                          <button class="btn btn-secondary btn-sm" style="pointer-events: none;">mins before alert</button>
                          <input type="number" class="form-control form-control-sm my-1" step="1" min="0" id="afterInterval" style="width: 9%;"
                            name="afterInterval" [(ngModel)]="afterInterval" (change)="onChangeTimeValue()">
                          <button class="btn btn-secondary btn-sm" style="pointer-events: none;">mins after alert</button>
                        </div>
                        <div class="form-group form-inline my-1">
                          <label class="mr-2">Widgets: </label>
                          <angular2-multiselect
                            [data]="dropdownWidgetList"
                            id="widgets"
                            [(ngModel)]="selectedWidgets"
                            name="widgets"
                            [settings]="{
                              text: 'Select Widgets',
                              selectAllText: 'Select All',
                              unSelectAllText: 'UnSelect All',
                              classes: 'col-lg-3 col-xl-3 p-0',
                              enableSearchFilter: true,
                              badgeShowLimit: 1,
                              maxHeight: 200,
                              labelKey: 'id'
                            }"
                          >
                          </angular2-multiselect>

                        </div>

                        <div class="form-group form-inline my-1">
                          <input type="checkbox" class="mx-1 my-1 big-checkbox" id="checkbox" min="1"
                          name="checkbox" [(ngModel)]="filterObj.isTypeEditable" (change)="filterObj.aggregation_format = 'AVG'; filterObj.aggregation_minutes = 1;
                          filterObj.sampling_format = 'minute'; filterObj.sampling_time = 1;
                          ">

                          <fieldset [disabled]="!filterObj.isTypeEditable" class="form-group form-inline my-1">
                          <ui-switch   class="mr-1" [disabled]="!filterObj.isTypeEditable"
                          defaultBgColor="#f6c23e" checkedTextColor="white" uncheckedTextColor="white"
                          checkedLabel="Sampling Frequency" (valueChange)="filterObj.aggregation_format = 'AVG'; filterObj.aggregation_minutes = 1;
                          filterObj.sampling_format = 'minute'; filterObj.sampling_time = 1;
                          "
                          uncheckedLabel="Aggregation" [(ngModel)]="filterObj.type" name="tpye"></ui-switch>

                          <ng-container *ngIf="!filterObj.type">
                          <input type="number" class="form-control form-control-sm my-1 w-7" id="minutes" min="1"
                            name="minutes" [(ngModel)]="filterObj.aggregation_minutes" placeholder="Agreegation Time"
                            (change)="onNumberChange($event, 'aggregation')">
                          <button class="btn btn-secondary btn-sm mr-1" style="pointer-events: none;">mins</button>
                          <select class="form-control form-control-sm mx-1 my-1" id="aggregationFormat" [(ngModel)]="filterObj.aggregation_format"
                          name="aggregationFormat" style="width: 11rem!important;">
                          <option [ngValue]="undefined">Aggregartion Format</option>
                          <option [ngValue]="'AVG'">Average</option>
                          <option [ngValue]="'SUM'">Sum</option>
                          <option [ngValue]="'MIN'">Min</option>
                          <option [ngValue]="'MAX'">Max</option>
                          <option [ngValue]="'COUNT'">Count</option>
                          </select>
                          </ng-container>
                          <ng-container *ngIf="filterObj.type">
                          <input type="number" class="form-control form-control-sm ml-1 my-1 w-7" id="minutes" min="1"
                            name="minutes" [(ngModel)]="filterObj.sampling_time" placeholder="Sampling" disabled
                            (change)="onNumberChange($event, 'sampling')" title="By default this is 1 minute. Right now this field is disabled. Dynamic selection of sampling frequency is under development.">
                          <!-- <select class="form-control form-control-sm mx-1 my-1" id="samplingFrequency" [(ngModel)]="filterObj.sampling_format"
                          name="samplingFrequency" style="width: 11rem!important;" disabled>
                          <option [ngValue]="undefined">Frequency</option>
                          <option [ngValue]="'second'">Second</option>
                          <option [ngValue]="'minute'">Minute</option>
                          <option [ngValue]="'hour'">Hour</option>
                          </select> -->
                          <button class="btn btn-secondary btn-sm mr-1" style="pointer-events: none;">mins</button>
                          </ng-container>
                          </fieldset>
                          <button type="button" class="btn btn-warning btn-sm mx-1 my-1" title="Apply Filter"
                          (click)="getDeviceTelemetryData()">Apply</button>
                          <i  *ngIf="isTelemetryDataLoading" class="fa fa-fw fa-2x  fa-spin fa-spinner"></i>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </accordion-group>
            <accordion-group heading="" [panelClass]="'customClass'" [isOpen]="isChartViewOpen" *ngIf="isTelemetryFilterSelected">
              <ng-container accordion-heading>
                <a class="btn" >
                  Alert Visualization
                </a>
              </ng-container>
              <div >
                <div class="row col-12 pl-5" *ngIf="!isTelemetryDataLoading && telemetryData.length > 0">

                  <div class="col-2 form-group " *ngFor="let prop of propList">
                    <input type="checkbox" class="form-check-input" id="{{prop}}"
                    name="{{prop}}" (change)="toggleProperty(prop)" [checked]="selectedPropertyForChart.indexOf(prop) !== -1">
                    <label class="form-check-label" for="{{prop}}">{{getPropertyName(prop)}}</label>
                  </div>

                  <div class="col-2 pull-right">
                    <input type="checkbox" class="form-check-input" id="threshold"
                      name="threshold" (change)="toggleThreshold()" [(ngModel)]="showThreshold">
                      <label class="form-check-label" for="threshold">Show Threshold</label>
                  </div>
                </div>
                <div class="row col-12 pl-5" *ngIf="!isTelemetryDataLoading && telemetryData.length === 0">
                  No data found.
                </div>
                <div *ngIf="isTelemetryDataLoading"><i class="fa fa-fw fa-2x  fa-spin fa-spinner"></i></div>
                <div id="charts" classs="w-100 row"></div>
              </div>
            </accordion-group>
            <accordion-group heading="" [panelClass]="'customClass'" [isOpen]="isOpen" *ngIf="alertCondition">
              <ng-container accordion-heading>
                <a class="btn" >
                 Recommendations
                </a>
              </ng-container>
              <div class="">
                <div class="">
                  <div class="">
                    <div class="table-responsive" *ngIf="alertCondition?.recommendations?.length > 0">
                      Following recommendations have been pre-configured.
                      <table id="mytable" width="100%" class="table table-bordered table-striped col-12">
                        <tbody>
                          <ng-container *ngFor="let step of alertCondition.recommendations; let i = index;" >
                          <tr  *ngIf="alertCondition.recommendations.length > 0">

                          <ng-container >
                            <td style="width: 10%;">Step - {{i + 1}}</td>
                            <td style="width: 30%;">{{step.description}}</td>
                            <td style="width: 30%;">{{step.activity}} Activity</td>

                          </ng-container>
                          </tr>
                          <tr *ngIf="alertCondition.recommendations.length === 0">
                            <td colspan="4"> No Recommedation Steps added.</td>
                          </tr>
                          </ng-container>
                        </tbody>
                      </table>
                    </div>
                    <div class="table-responsive" *ngIf="alertCondition?.recommendations?.length === 0">
                      No Recommendations added yet.
                    </div>
                    <h6>Reference Documents:</h6>
                    <div class="tagsinput" style="width: auto; height: auto;min-height: auto;" *ngIf="alertCondition?.reference_documents?.length > 0">
                      <ng-container *ngFor="let item of alertCondition.reference_documents; let index = index">
                        <span class="tag" >
                          <span class="tag-text">{{item}}</span>
                        </span>
                      </ng-container>
                    </div>
                    <div class="tagsinput" style="width: auto; height: auto;min-height: auto;" *ngIf="alertCondition?.reference_documents?.length === 0">
                    No Reference documents added yet.</div>
                  </div>
                </div>
              </div>
            </accordion-group>
            <accordion-group heading="" [panelClass]="'customClass'" [isOpen]="isOpen" *ngIf="alertCondition">
              <ng-container accordion-heading>
                <a class="btn" >
                 Actions Taken
                </a>
              </ng-container>
              <div class="">
                <div class="">
                  <div class="">
                    <h6 class="font-weight-bold"><u>By Field Staff:</u></h6>
                    <div class="table-responsive" *ngIf="!selectedAlert?.metadata?.acknowledged_date; else actionTakenTemplate">
                      No Actions recorded by field staff yet.
                    </div>
                    <ng-template #actionTakenTemplate>
                      <div class="table-responsive">
                        <p> Alert acknowledged by {{selectedAlert?.metadata?.user_id}} at {{selectedAlert?.metadata?.acknowledged_date}}.</p>
                        <p>Reason: {{selectedAlert?.metadata?.reason?.reason ? selectedAlert?.metadata?.reason?.reason: 'NA'}}</p>
                        <p>Notes: {{selectedAlert?.metadata?.note ? selectedAlert?.metadata?.note : 'NA'}}</p>
                      </div>
                    </ng-template>
                    <h6 class="font-weight-bold"><u>By RDM:</u></h6>
                    <div class="table-responsive">
                      No Actions recorded by RDM yet.
                    </div>
                  </div>
                </div>
              </div>
            </accordion-group>
          </accordion>

        </ng-container>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary add-row" (click)="closeModal('alertVisualizationModal')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal right fade" id="acknowledgemenConfirmModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel2">
  <div class="modal-dialog" role="document">
    <div class="modal-content" *ngIf="acknowledgedAlert">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Acknowledge Alert</h5>
        <button type="button" class="close" (click)="closeAcknowledgementModal(true)" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <h6>Are you sure you want to acknowledge this alert?</h6>
          <div class="form-group">
            <label for="recipient-name" class="col-form-label">Reason:</label>
            <select class="custom-select" id="alertReason" [(ngModel)]="acknowledgedAlert.metadata.reason"
              name="alertReason">
              <option [ngValue]="undefined">Select Reason</option>
              <option [ngValue]="reason" *ngFor="let reason of reasons">{{reason.reason}}</option>

            </select>
          </div>
          <div class="form-group">
            <label for="recipient-name" class="col-form-label">Notes:</label>
            <textarea type="text" rows="3" class="form-control" id="note" name="note" [(ngModel)]="acknowledgedAlert.metadata.note"
          placeholder="Enter Notes"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="acknowledgeAlert()">Acknowledge</button>
        <button type="button" class="btn btn-secondary add-row" (click)="closeAcknowledgementModal(true)">Cancel</button>
      </div>
    </div>
  </div>
</div>
