<div class="tab-bar">
  <form class="form-inline">
    <div class="form-group" id="dd-open">
      <button href="#" role="button" class="dropdown-btn" data-toggle="dropdown" placement="bottom"
        [tooltip]="hierarchyString ? hierarchyString : 'Select Hierarchy'" (click)="onAssetFilterBtnClick()"
        aria-haspopup="true" aria-expanded="false" [ngClass]="{'active': hierarchyString}">
        <i class="fas fa-fw fa-filter fa-sm button-divider mr-1"></i>{{hierarchyString ? displayHierarchyString :
        'Select Hierarchy'}} </button>
      <div class="dropdown-menu dropdown-filter-content" id="liveDataSelectAssret">
        <ng-container *ngFor="
                    let level of contextApp?.hierarchy?.levels;
                    let index = index
                  ">
          <div class="">
            <select *ngIf="index !== 0" name="{{level}}_{{index}}" class="dropdown-form" id="{{ level }}"
              [disabled]="contextApp?.user?.hierarchy[level]" [(ngModel)]="configureHierarchy[index]" name="{{ level }}"
              (change)="onChangeOfHierarchy(index, 'PG')">
              <option [ngValue]="undefined">
                Select {{ level }}
              </option>
              <option [ngValue]="tag" *ngFor="let tag of hierarchyArr[index]">
                {{ tag }}
              </option>
            </select>
            <input type="text" *ngIf="index === 0" name="{{level}}_{{index}}" defaultValue="{{ contextApp.app }}"
              disabled class="dropdown-form" />
          </div>
        </ng-container>
        <div class="form-group">
          <button type="button" placement="bottom" tooltip="Search" class="btn btn-sm searchBtn btn-primary"
            (click)="onSaveHierachy()">Apply</button>
          <button type="button" placement="bottom" tooltip="Clear" class="btn btn-sm searchBtn btn-white ml-1"
            (click)="onClearHierarchy()">Clear</button>
        </div>
        <!-- <div class="">
          <button class="btn btn-sm searchBtn btn-primary" type="button" (click)="onAssetFilterApply()">Apply</button>
        </div> -->

        <!-- <ng-select [items]="assets" class="custom-dropdown w-12" bindLabel="display_name" [clearable]="false"
          [searchable]="true" [closeOnSelect]="true" appendTo="#liveDataSelectAssret" placeholder="Select Asset"
          dropdownPosition="bottom" name="asset-dropdown" [(ngModel)]="filterObj.asset" (onSelect)="onAssetSelection()">
        </ng-select> -->
      </div>
    </div>
    <!-- <div class="form-group">
      <select class="custom-select custom-select-sm" id="report_type" [(ngModel)]="filterObj.report_type"
          name="report_type" #reportType="ngModel">
          <option [ngValue]="undefined">Select Report Type</option>
          <option [ngValue]="'Daily Single Asset Raw Telemetry Report'">Daily Single Asset Raw Telemetry Report</option>
          <option [ngValue]="'Daily Multiple Asset Raw Telemetry Report'">Daily Multiple Asset Raw Telemetry Report</option>
          <option [ngValue]="'Daily Single Asset Sampling Telemetry Report'">Daily Single Asset Sampling Telemetry Report</option>
          <option [ngValue]="'Daily Multiple Asset Sampling Telemetry Report'">Daily Multiple Asset Sampling Telemetry Report</option>
          <option [ngValue]="'Weekly Single Asset Raw Telemetry Report'">Weekly Single Asset Raw Telemetry Report</option>
          <option [ngValue]="'Weekly Single Asset Sampling Telemetry Report'">Weekly Single Asset Sampling Telemetry Report</option>

          </select>
    </div> -->
    <div class="form-group left-inner-addon">
      <i class="fa fa-calendar" [ngClass]="{'active': filterObj.from_date && filterObj?.to_date}"></i>
      <input type="text" readonly class="form-control form-control-sm date-range-picker" daterangepicker
        name="daterangeInput" autocomplete="off" [(ngModel)]="selectedDateRange" [options]="options"
        (selected)="selectedDate($event, daterange)" [ngClass]="{'active': filterObj.from_date && filterObj?.to_date}"
        [tooltip]="selectedDateRange" placement="bottom" />
    </div>
    <div class="form-group">
      <button type="button" class="btn btn-sm searchBtn btn-primary" placement="bottom" tooltip="Search"
        (click)="reports = [];currentOffset = 0;getReportsData(true)"><i class="fa fa-search fa-sm"></i></button>
    </div>
    <div class="form-group">
      <button class="btn btn-sm searchBtn btn-success" (click)="onOpenConfigurePGRModal()" placement="bottom"
        tooltip="Configure New PreGenerated Report"><i class="fa fa-cog fa-sm text-white"></i></button>
    </div>
  </form>
</div>
<h6 class="p-3" *ngIf="!isFilterSelected"> Please select filters to view the pre-generated reports.</h6>
<ng-container *ngIf="isFilterSelected">
  <!-- <h5  >Pre-generated</h5> -->
  <div class="table-responsive">
    <div class="tableFixHead" id="table-top">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>No</th>
            <th>Asset Name</th>
            <th>Date</th>
            <th>Category</th>
            <th>Type</th>
            <th>Size</th>
            <!-- <th>Type</th>
        <th>Frequency</th> -->
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngIf="reports.length > 0">
            <tr *ngFor="let reportObj of reports; let index = index">
              <td>{{index + 1}}</td>
              <td>
                <ng-container *ngFor="let assetId of reportObj.assets">
                  {{ getAssetNameById(assetId)}}
                </ng-container>
              </td>
              <td>{{ reportObj.report_frequency?.toLowerCase() === 'daily' ? (reportObj.local_start_date) :
                (reportObj.local_start_date + ' to ' + reportObj.local_end_date)}}</td>
              <!-- <td>{{ reportObj.local_end_date }}</td> -->

              <td>{{reportObj.report_type}}</td>
              <td>{{reportObj?.report_category?.toLowerCase() === 'telemetry' ? 'Telemetry Report' :
                (reportObj?.report_category?.toLowerCase() === 'alert' ? 'Alert Report' : '')}}</td>
              <!-- <td>{{reportObj.report_type.method | titlecase}}</td>
          <td>{{reportObj.report_frequency | titlecase}}</td> -->
              <td>{{reportObj.metadata?.file_size}}</td>
              <td>
                <a *ngIf="reportObj.process_status.toLowerCase() === 'success'" href="javascript:void(0)"
                  (click)="downloadFile(reportObj)" placement="bottom" tooltip="Download Excel"><i
                    class="fa fa-sm fa-download"></i></a>
                <ng-container *ngIf="reportObj.process_status.toLowerCase() !== 'success'">{{reportObj.process_status}}
                </ng-container>
              </td>
            </tr>
          </ng-container>
          <ng-container *ngIf="reports.length === 0 && !isReportDataLoading">
            <tr>
              <td colspan="7">No reports available for {{this.previousFilterObj.dateOption}}. <p
                  *ngIf="this.previousFilterObj.dateOption !== 'this selected range'; else differentMsg" class="pt-2">
                  You can choose large time window.</p>
                <ng-template #differentMsg>
                  <p class="pt-2">You can choose different time window.</p>
                </ng-template>
              </td>
            </tr>
          </ng-container>
          <ng-container *ngIf="isReportDataLoading">
            <tr>
              <td colspan="7">
                <i class="fa fa-fw fa-2x  fa-spin fa-spinner"></i>
              </td>
            </tr>
          </ng-container>

        </tbody>
      </table>
    </div>
  </div>
  <span class="pull-right mt-1 mr-1" *ngIf="!insideScrollFunFlag && reports.length > 0">
    <a href="javascript:void(0)" class="mr-1"
      (click)="currentOffset = currentOffset + currentLimit;getReportsData(false);" placement="bottom"
      tooltip="Load More Records...">Load More...</a>
  </span>
</ng-container>
<div class="modal fade" id="downloadPreGeneratedReportReportModal" tabindex="-1" role="dialog"
  aria-labelledby="ModalLabel2">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="exampleModalLabel">Download Report</h6>
        <button type="button" class="close" (click)="cancelDownloadModal()" *ngIf="isDownloadCloseOptionAvailable"
          aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ng-container>
          Downloading Report. Please wait...
          <i class="fa fa-spinner fa-spin fa-fw fa-2x"></i>
        </ng-container>
      </div>
      <div class="modal-footer" *ngIf="isDownloadCloseOptionAvailable">
        <button type="button" class="btn btn-secondary add-row" (click)="cancelDownloadModal()">Cancel</button>
      </div>
    </div>

  </div>
</div>
<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" (click)="scrollToTop()">
  <i class="fas fa-angle-up"></i>
</a>
<div class="modal right fade" id="configurePGRModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel2">
  <div class="modal-dialog" role="document">
    <div class="modal-content" *ngIf="isAddReport">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Configure New Report</h5>
        <button type="button" class="close" [disabled]="isCreateReportAPILoading" (click)="onCloseConfigurePGRModal()"
          aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="col-12">
          <form class="">
            <div class="form-group">
              <label for="message-text" class="col-form-label required">Report Name:</label>
              <input type="text" class="form-control form-control-sm" id="report_name" name="report_name"
                [(ngModel)]="reportsObj.report_name" placeholder="Enter Report Name">
            </div>
            <div class="form-group">
              <label for="recipient-name" class="col-form-label required">Asset Model:</label>
              <select class="custom-select custom-select-sm" id="asset_model" name="asset_model"
                [(ngModel)]="reportsObj.asset_model" (change)="onChangeAssetsModel()">
                <option [ngValue]="undefined"> Select Model</option>
                <option *ngFor="let item of assetModels" [ngValue]="item.name">
                  {{item.name}}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="message-text" class="col-form-label required">Asset:</label>
              <ng-container *ngFor="let level of contextApp?.hierarchy?.levels; let index = index">
                <div class="my-1">
                  <!-- <label for="message-text" class="col-form-label">{{level}}:</label> -->
                  <select *ngIf="index !== 0" class="custom-select custom-select-sm" id="{{ level }}"
                    name="{{level}}_{{index}}" [(ngModel)]="configureHierarchy[index]"
                    [disabled]="contextApp.user.hierarchy[level]" (change)="onChangeOfHierarchy(index, 'RS')">
                    <option [ngValue]="undefined"> Select {{level}}</option>
                    <option [ngValue]="tag" *ngFor="let tag of hierarchyArr[index]">{{tag}}</option>
                  </select>
                  <input type="text" *ngIf="index === 0" class="form-control form-control-sm" name="{{level}}_{{index}}"
                    defaultValue="{{ contextApp.app }}" disabled />
                </div>
              </ng-container>
              <ng-select [items]="assets" class="custom-dropdown w-12 sm" [clearable]="false"
              [searchable]="true" [multiple]="true" bindLabel="display_name" bindValue="asset_id" 
              [closeOnSelect]="false" placeholder="Select Asset" dropdownPosition="bottom"
              name="report-asset-dropdown" [(ngModel)]="reportsObj.assets" (onDeSelectAll)="Deselect($event)">
              <ng-template ng-header-tmp>
                <ul style="list-style-type:none;line-height: 1.5rem;" class="m-0 p-0">
                  <li *ngIf="reportsObj.assets.length !== assets.length"> <a href="javascript:void(0)"
                      (click)="reportsObj.assets = assets">Select All</a></li>
                  <li *ngIf="reportsObj.assets.length === assets.length"> <a href="javascript:void(0)"
                      (click)="reportsObj.assets = []">Deselect All</a></li>
                </ul>
              </ng-template> 
              <ng-template ng-multi-label-tmp let-items="items">
                {{items.length}} Assets selected
              </ng-template>
              <ng-template ng-option-tmp let-asset="item">
                <span [tooltip]="asset.display_name ? asset.display_name: asset.asset_id"> {{asset.display_name ?
                  asset.display_name: asset.asset_id}}</span>
              </ng-template> 
            </ng-select>
            </div>
            <div class="form-group">
              <label for="message-text" class="col-form-label required">Report Category:</label>
              <select class="custom-select custom-select-sm" id="report_category"
                [(ngModel)]="reportsObj.report_category" name="report_category" (change)="onReportChange()"
                #reportType="ngModel">
                <option [ngValue]="undefined">Report Category</option>
                <option [ngValue]="'telemetry'">Telemetry Report</option>
                <option [ngValue]="'alert'">Alert Report</option>
              </select>
            </div>
            <ng-container *ngIf="reportsObj.report_category === 'telemetry'">
              <div class="form-group">
                <label for="message-text" class="col-form-label required">Properties:</label>
                <ng-select [items]="dropdownPropList" class="custom-dropdown w-12 sm" [clearable]="false"
                  [searchable]="true" clearSearchOnAdd="true" [multiple]="true" bindLabel="id" [closeOnSelect]="false"
                  placeholder="Select Properties" groupBy="type" dropdownPosition="bottom" name="asset-dropdown"
                  [(ngModel)]="props" (onDeSelectAll)="y1Deselect($event)">
                  <ng-template ng-header-tmp>
                    <ul style="list-style-type:none;line-height: 1.5rem;" class="m-0 p-0">
                      <li *ngIf="props.length !== dropdownPropList.length"> <a href="javascript:void(0)"
                          (click)="props = dropdownPropList">Select All</a></li>
                      <li *ngIf="props.length === dropdownPropList.length"> <a href="javascript:void(0)"
                          (click)="props = []">Deselect All</a></li>
                    </ul>
                  </ng-template>
                  <ng-template ng-multi-label-tmp let-items="items">
                    {{items.length}} properties selected
                  </ng-template>
                  <ng-template ng-option-tmp let-item="item">
                    <span [tooltip]="item.id">
                      <i
                        [ngClass]="{'icon icon-function': item.value.type === 'Edge Derived Properties' || item.value.type === 'Cloud Derived Properties'}"></i>
                      {{item.id}}
                    </span>
                  </ng-template>
                </ng-select>
              </div>
            </ng-container>
            <div class="form-group">
              <label for="message-text" class="col-form-label required">Report Type:</label>
              <select class="custom-select custom-select-sm" id="report_type" [(ngModel)]="reportsObj.report_type"
                name="report_type">
                <option [ngValue]="undefined">Select Report Type</option>
                <option [ngValue]="'Raw'">RAW</option>
                <option [ngValue]="'Sampling'">Sampling</option>
              </select>
            </div>
            <div class="form-group">
              <label for="message-text" class="col-form-label required">Report Frequency:</label>
              <select class="custom-select custom-select-sm" id="report_frequency"
                [(ngModel)]="reportsObj.report_frequency" name="report_frequency">
                <option [ngValue]="undefined">Select Report Frequency</option>
                <option [ngValue]="'Daily'">Daily</option>
                <option [ngValue]="'Weekly'">Weekly</option>
              </select>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary add-row" [disabled]="isCreateReportAPILoading"
          (click)="onCreateNewPGReports()">Save</button>
        <button type="button" class="btn btn-secondary" [disabled]="isCreateReportAPILoading"
          (click)="onCloseConfigurePGRModal()">Cancel</button>
        <i class="fa fa-spinner fa-spin fa-fw fa-2x" *ngIf="isCreateReportAPILoading"></i>
      </div>
    </div>
  </div>
</div>

