<div class="topnavbar">
  <div class="d-sm-flex align-items-center justify-content-start mb-2 mt-n3 pl-1">
    <h5 class="h4 mb-0 text-gray-800">{{tileData && tileData[0] ? tileData[0]?.value : ''}}</h5>
  </div>
  <div class="card row bg-white" style="margin-left:-2rem">
    <div class="col-xl-12 col-md-12 mb-12">
      <form>
        <div class="form-group form-inline my-2 mx-3">
          <ng-container *ngFor="let level of contextApp?.hierarchy?.levels; let index = index;">
          <select *ngIf="index !== 0" class="form-control form-control-sm mx-1 my-1" id="{{level}}"
          [disabled]="contextApp?.user?.hierarchy[level]"
          [(ngModel)]="configureHierarchy[index]" name="{{level}}" (change)="onChangeOfHierarchy(index)">
            <option [ngValue]="undefined">Select {{level}}</option>
            <option [ngValue]="tag" *ngFor="let tag of hierarchyArr[index]">
              {{tag}}
            </option>
          </select>
          <input  type="text" *ngIf="index === 0"  defaultValue="{{contextApp.app}}" disabled class="form-control form-control-sm mx-1 my-1">
        </ng-container>
        <select class="form-control form-control-sm mx-1 my-1" id="deviceCategory" [(ngModel)]="filterObj.device"
        name="deviceCategory" (change)="onAssetSelection()">
        <option [ngValue]="undefined">Select Asset</option>
        <option [ngValue]="device" *ngFor="let device of devices">
          {{device?.display_name ? device?.display_name: device.device_id}}
        </option>
        </select>
        <!-- <select class="form-control form-control-sm mx-1 my-1" id="deviceCategory1" [(ngModel)]="filterObj.non_ip_device"
          name="deviceCategory1" *ngIf="filterObj.device?.cloud_connectivity.includes('Gateway')"
          (change)="onNonIPDeviceChange()">
          <option [ngValue]="undefined">Select Asset</option>
          <option [ngValue]="device" *ngFor="let device of nonIPDevices">
            {{device?.display_name ? device?.display_name: device.device_id}}
          </option>
        </select> -->
        </div>
        <div class="row form-group form-inline  my-2 mx-3">

          <!-- <input type="number" min="1" class="form-control form-control-sm mx-1 my-1 record-input" id="inputEmail4"
            placeholder="No of Records" [(ngModel)]="filterObj.count" name="count"> -->

          <select class="form-control form-control-sm mx-1 my-1" id="report_type" [(ngModel)]="filterObj.report_type"
          name="report_type" (change)="onNonIPDeviceChange()">
          <option [ngValue]="undefined">Select Report Type</option>
          <option [ngValue]="'Telemetry Report'">Telemetry Report</option>
          <option [ngValue]="'Alert Report'">Alert Report</option>
          </select>
          <angular2-multiselect [data]="dropdownPropList" id="y1AxisProperty" *ngIf=" filterObj.report_type === 'Telemetry Report'"
              [(ngModel)]="props" name="props" [settings]="{
                text: 'Select Property',
                selectAllText: 'Select All',
                unSelectAllText: 'UnSelect All',
                classes: 'col-lg-2 col-xl-2 p-0 ml-2',
                enableSearchFilter: true,
                badgeShowLimit: 1,
                maxHeight: 200,
                labelKey: 'id'
              }"
              (onDeSelectAll)="y1Deselect($event)">
            </angular2-multiselect>
            <div class="bg-dateRow form-group form-inline" id="dateRow" style="width: 42rem;">
          <select class="form-control form-control-sm mx-1 my-1" id="dateoptions" [(ngModel)]="filterObj.dateOption"
            name="dateOptions" (change)="onDateOptionChange();dt1Input.value = null;dt2Input.value = null;">
            <option [ngValue]="undefined">Quick Options</option>
            <option [ngValue]="'5 mins'">Last 5 minutes</option>
            <option [ngValue]="'30 mins'">Last 30 minutes</option>
            <option [ngValue]="'1 hour'">Last 1 hour</option>
            <option [ngValue]="'24 hour'">Last 24 hours</option>
          </select>
          <label class="ml-1 mr-1">OR</label>
          <ng-container>
            <input #dt2Input [owlDateTime]="dt2"  (dateTimeChange)="onSingleDateChange($event);dt1Input.value = null;filterObj.dateOption = undefined;"
              class="form-control form-control-sm mx-1 my-1 w-10" [owlDateTimeTrigger]="dt2"
              placeholder="Select Date">
            <span [owlDateTimeTrigger]="dt2"  class="datepicker-calendar"><i class="fa fa-calendar"></i></span>
            <owl-date-time #dt2 [pickerType]="'calendar'"></owl-date-time>
          </ng-container>
          <label class="ml-3 mr-1">OR</label>
          <ng-container>
            <input #dt1Input [owlDateTime]="dt1" [selectMode]="'range'" (dateTimeChange)="onDateChange($event);dt2Input.value = null;filterObj.dateOption = undefined;"
              class="form-control form-control-sm mx-1 my-1 w-15" [owlDateTimeTrigger]="dt1"
              placeholder="Select Date Range">
            <span [owlDateTimeTrigger]="dt1" class="datepicker-calendar"><i class="fa fa-calendar"></i></span>
            <owl-date-time #dt1></owl-date-time>
          </ng-container>
          </div>
          <button type="button" class="btn btn-warning btn-sm mx-3 my-1" title="Search" (click)="onFilterSelection()" ><i
              class="fas fa-search fa-sm"></i></button>
          <!-- <button type="button" class="btn btn-white btn-sm mx-1 my-1" title="Clear" (click)="clear()"><i class="fas fa-trash  fa-sm"></i></button> -->

        </div>
      </form>
    </div>
  </div>


</div>
<div class="contain-pad" style="margin-top: 14rem;">
  <div class="mb-2">
    <h6 *ngIf="!isFilterSelected"> Please select filters to view the report data.</h6>
    <div class="table-responsive" *ngIf="isFilterSelected || isTelemetryLoading">
      <h5 >{{filterObj.report_type}}
        <a href="javascript:void(0)" (click)="savePDF()" title="Export as PDF"><i class="fa fa-sm fa-file-pdf-o" ></i></a>
        <a href="javascript:void(0)" (click)="saveExcel()" title="Export as Excel" class="ml-1"><i class="fa fa-sm fa-file-excel-o" ></i></a>

      </h5>
      <table class="table table-bordered table-striped"  id="dataTable" width="100%" cellspacing="0"
      *ngIf="isFilterSelected && filterObj.report_type === 'Telemetry Report'">
        <thead>
          <tr class="bg-secondary text-white">
            <th>Asset Name</th>
            <th>Time</th>
            <th *ngFor="let property of selectedProps"> {{property.id}}</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngIf="telemetry.length > 0 && !isTelemetryLoading">
            <tr *ngFor="let telemetryObj of telemetry">

              <td>{{ filterObj.non_ip_device ?
                (filterObj.non_ip_device.device_display_name ? filterObj.non_ip_device?.device_display_name : filterObj.non_ip_device?.device_id)
              : (filterObj.device ?
              (filterObj.device.device_display_name ? filterObj.device.device_display_name : filterObj.device.device_id)
              : '' )}}</td>
              <td>{{ telemetryObj.local_created_date }}</td>
              <td *ngFor="let prop of selectedProps"> {{telemetryObj[prop.value.json_key]}}</td>
                          </tr>
          </ng-container>
          <ng-container *ngIf="telemetry.length === 0 && !isTelemetryLoading">
            <tr>
              <td [attr.colspan]="2 + selectedProps.length">No telemetry data available.</td>
            </tr>
          </ng-container>
           <ng-container *ngIf="telemetry.length === 0 && isTelemetryLoading">
            <tr>
              <td [attr.colspan]="2 + selectedProps.length">
                <i  class="fa fa-fw fa-2x  fa-spin fa-spinner"></i>
              </td>
            </tr>
          </ng-container>

        </tbody>
      </table>
      <table class="table table-bordered table-striped"  id="dataTable" width="100%" cellspacing="0"
      *ngIf="isFilterSelected && filterObj.report_type === 'Alert Report'">
        <thead>
          <tr class="bg-secondary text-white">
            <th>Code</th>
            <th>Asset Name</th>
            <th>Time</th>
            <th>Description</th>
            <th>Status</th>
            <th>Acknowledged By</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngIf="latestAlerts.length > 0">
            <tr *ngFor="let alert of latestAlerts" [ngClass]="{'bg-danger text-white': alert.severity.toLowerCase() === 'critical'}">
              <td><i class="fa fa-exclamation-triangle" [style.color]="
                (alert.severity.toLowerCase() === 'critical' ? '#cc0000' :
                (alert.severity.toLowerCase() === 'error' ? '#fb5515' :
                (alert.severity.toLowerCase() === 'warning' ? '#f6c23e' :
                (alert.severity.toLowerCase() === 'informational' ? '#229954' : ''))
                )
                )" title="{{alert.severity}}"></i>&nbsp;{{alert.code}}</td>

              <td>{{ alert.device_display_name ? alert.device_display_name : alert.device_id }}</td>

              <td>{{ alert.local_created_date }}</td>
              <td>{{ alert.message }}</td>
              <td> {{alert.metadata?.acknowledged_date ? 'Acknowledged' : 'Not Acknowledged'}}
              </td>
              <td>{{ alert.metadata?.user_id }}</td>
            </tr>
          </ng-container>
          <ng-container *ngIf="latestAlerts.length === 0">
            <tr>
              <td colspan="6">No Alert data available.</td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>
